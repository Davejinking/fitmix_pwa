#!/bin/bash

# ============================================================================
# Lifto í…ŒìŠ¤íŠ¸ í™˜ê²½ ìë™ ì„¸íŒ… ìŠ¤í¬ë¦½íŠ¸
# ============================================================================
# ëª©ì : Jules(Cloud AI)ê°€ ì„¸ì…˜ ì´ˆê¸°í™” í›„ ì¦‰ì‹œ í…ŒìŠ¤íŠ¸ ì‘ì„±/ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡
#      ê°œë°œ í™˜ê²½ì„ ìë™ìœ¼ë¡œ ì¤€ë¹„í•©ë‹ˆë‹¤.
# ============================================================================

set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ë¡œê·¸ í•¨ìˆ˜
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ============================================================================
# 1. í™˜ê²½ ê²€ì¦
# ============================================================================

log_info "Step 1: í™˜ê²½ ê²€ì¦ ì¤‘..."

# Flutter ì„¤ì¹˜ í™•ì¸
if ! command -v flutter &> /dev/null; then
    log_error "Flutterê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    log_info "ì„¤ì¹˜ ë°©ë²•: https://flutter.dev/docs/get-started/install"
    exit 1
fi

log_success "Flutter ì„¤ì¹˜ í™•ì¸ë¨"

# Dart ì„¤ì¹˜ í™•ì¸
if ! command -v dart &> /dev/null; then
    log_error "Dartê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    exit 1
fi

log_success "Dart ì„¤ì¹˜ í™•ì¸ë¨"

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ í™•ì¸
if [ ! -f "pubspec.yaml" ]; then
    log_error "pubspec.yamlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”."
    exit 1
fi

log_success "í”„ë¡œì íŠ¸ ë£¨íŠ¸ í™•ì¸ë¨"

# ============================================================================
# 2. íŒ¨í‚¤ì§€ ì„¤ì¹˜
# ============================================================================

log_info "Step 2: íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."

flutter pub get

log_success "íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

# ============================================================================
# 3. ì½”ë“œ ìƒì„± (í•„ìš”í•œ ê²½ìš°)
# ============================================================================

log_info "Step 3: ì½”ë“œ ìƒì„± ì¤‘..."

# build_runner í™•ì¸
if grep -q "build_runner" pubspec.yaml; then
    log_info "build_runner ê°ì§€ë¨. ì½”ë“œ ìƒì„± ì‹¤í–‰..."
    dart run build_runner build --delete-conflicting-outputs
    log_success "ì½”ë“œ ìƒì„± ì™„ë£Œ"
else
    log_warning "build_runnerê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì„ íƒì‚¬í•­)"
fi

# ============================================================================
# 4. í…ŒìŠ¤íŠ¸ í´ë” êµ¬ì¡° í™•ì¸
# ============================================================================

log_info "Step 4: í…ŒìŠ¤íŠ¸ í´ë” êµ¬ì¡° í™•ì¸ ì¤‘..."

# test í´ë” ìƒì„±
if [ ! -d "test" ]; then
    mkdir -p test
    log_success "test í´ë” ìƒì„±ë¨"
fi

# test/bugs í´ë” ìƒì„±
if [ ! -d "test/bugs" ]; then
    mkdir -p test/bugs
    log_success "test/bugs í´ë” ìƒì„±ë¨"
fi

# test/features í´ë” ìƒì„±
if [ ! -d "test/features" ]; then
    mkdir -p test/features
    log_success "test/features í´ë” ìƒì„±ë¨"
fi

# ============================================================================
# 5. ë¦°íŠ¸ ê²€ì‚¬ (ì„ íƒì‚¬í•­)
# ============================================================================

log_info "Step 5: ë¦°íŠ¸ ê²€ì‚¬ ì¤‘..."

if flutter analyze --no-fatal-infos 2>/dev/null; then
    log_success "ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼"
else
    log_warning "ë¦°íŠ¸ ê²½ê³ ê°€ ìˆìŠµë‹ˆë‹¤. (ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰)"
fi

# ============================================================================
# 6. í™˜ê²½ ì •ë³´ ì¶œë ¥
# ============================================================================

log_info "Step 6: í™˜ê²½ ì •ë³´ ì¶œë ¥ ì¤‘..."

echo ""
echo -e "${BLUE}=== í™˜ê²½ ì •ë³´ ===${NC}"
echo "Flutter ë²„ì „: $(flutter --version | head -1)"
echo "Dart ë²„ì „: $(dart --version)"
echo "í”„ë¡œì íŠ¸: $(grep '^name:' pubspec.yaml | cut -d' ' -f2)"
echo ""

# ============================================================================
# 7. ì™„ë£Œ
# ============================================================================

log_success "í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ì™„ë£Œ!"
echo ""
echo -e "${BLUE}=== ë‹¤ìŒ ë‹¨ê³„ ===${NC}"
echo "1. í…ŒìŠ¤íŠ¸ ì‘ì„±: test/bugs/ ë˜ëŠ” test/features/ í´ë”ì— í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±"
echo "2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰: flutter test"
echo "3. íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰: flutter test test/bugs/bug_xxx_test.dart"
echo ""
echo -e "${YELLOW}ğŸ’¡ íŒ: í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‘ì„± ì‹œ ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë”°ë¥´ì„¸ìš”:${NC}"
echo "   test/bugs/bug_XXX_description_test.dart"
echo "   test/features/feature_name_test.dart"
echo ""
